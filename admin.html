<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
body{font-family:Segoe UI,Arial;background:#f4f6fb;margin:0}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
label{display:block;margin-top:12px;font-weight:600}
input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #ddd;border-radius:8px}
button{margin-top:14px;padding:10px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.primary{background:#2563eb;color:#fff}
.success{background:#16a34a;color:#fff}
.warning{background:#f59e0b}
.danger{background:#dc2626;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:center}
th{background:#f1f5f9}
.hide{display:none}
</style>
</head>

<body>
<div class="container">

<h2>Admin Dashboard</h2>

<!-- ADD WORK -->
<div class="card">
  <h3 id="formTitle">Add Work</h3>

  <label>Farmer</label>
  <select id="farmerSelect"></select>

  <label>Work Type</label>
  <select id="workType">
    <option value="">Select Work</option>
    <option>దుక్కు</option>
    <option>లోడింగ్</option>
    <option>రోటావేటర్</option>
    <option>జొన్నలు</option>
    <option>వరిసేను ఆట</option>
    <option>గత్తం</option>
  </select>

  <label>Minutes</label>
  <input id="minutes" placeholder="1.20 = 1h 20m">

  <label>Rate / Hour</label>
  <input id="rate" type="number">

  <button id="submitBtn" class="primary">Add Work</button>
</div>

<!-- PAYMENT -->
<div class="card">
  <h3>Payment</h3>
  <label>Farmer</label>
  <select id="paymentFarmer"></select>

  <label>Amount</label>
  <input id="paymentAmount" type="number">

  <button class="success" onclick="makePayment()">Add Payment</button>
</div>

<!-- HISTORY -->
<div class="card">
  <label>Farmer History</label>
  <select id="farmerFilter"></select>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Work</th><th>Minutes</th><th>Rate</th>
        <th>Total</th><th>Paid</th><th>Balance</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- MANAGE FARMERS -->
<div class="card">
  <button class="warning" onclick="toggleFarmers()">Manage Farmers</button>
</div>

<div class="card hide" id="farmersBox">
  <label>Farmer</label>
  <select id="farmerDeleteSelect"></select>

  <label>Admin Password</label>
  <input id="adminDeletePass" type="password">

  <button class="danger" onclick="deleteFarmer()">Delete Farmer</button>
</div>

<!-- CHANGE PASSWORD -->
<div class="card">
  <button class="warning" onclick="togglePassword()">Change Admin Password</button>
</div>

<div class="card hide" id="passwordBox">
  <label>Old Password</label>
  <input id="oldPass" type="password">

  <label>New Password</label>
  <input id="newPass" type="password">

  <button class="primary" onclick="changePassword()">Update</button>
</div>

<div class="card">
  <button class="danger" onclick="logout()">Logout</button>
</div>

</div>

<script>
/* ================= BASIC SETUP ================= */
const API = "https://karthik-back.onrender.com";
const token = () => localStorage.getItem("token");

if(!token()){
  alert("Session expired");
  location.href = "index.html";
}

/* ================= DOM READY ================= */
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM loaded");
  setTimeout(loadFarmers, 500);
});

/* ================= LOAD FARMERS ================= */
async function loadFarmers(){
  try{
    console.log("Loading farmers...");

    const res = await fetch(API + "/api/admin/farmers", {
      headers:{ Authorization:"Bearer " + token() }
    });

    const data = await res.json();
    console.log("Farmers response:", data);

    let opt = "<option value=''>Select Farmer</option>";
    data.farmers.forEach(f=>{
      opt += `<option value="${f._id}">${f.name}</option>`;
    });

    farmerSelect.innerHTML =
    paymentFarmer.innerHTML =
    farmerFilter.innerHTML =
    farmerDeleteSelect.innerHTML = opt;

  }catch(e){
    console.error(e);
    alert("Farmer loading failed");
  }
}

/* ================= PAYMENT ================= */
async function makePayment(){
  await fetch(API+"/api/admin/payment",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({
      farmerId: paymentFarmer.value,
      amount: Number(paymentAmount.value)
    })
  });
  paymentAmount.value="";
  farmerFilter.value = paymentFarmer.value;
  loadHistory();
}

/* ================= HISTORY ================= */
farmerFilter.onchange = loadHistory;

async function loadHistory(){
  if(!farmerFilter.value) return;
  tbody.innerHTML="";

  const res = await fetch(API+"/api/admin/history/"+farmerFilter.value,{
    headers:{Authorization:"Bearer "+token()}
  });
  const {works,payments} = await res.json();

  works.forEach(w=>{
    tbody.innerHTML += `
    <tr>
      <td>${new Date(w.date).toLocaleDateString()}</td>
      <td>${w.workType}</td>
      <td>${w.minutes}</td>
      <td>${w.ratePer60}</td>
      <td>${w.totalAmount}</td>
      <td>-</td><td>-</td><td>-</td>
    </tr>`;
  });

  payments.forEach(p=>{
    tbody.innerHTML += `
    <tr style="background:#ecfdf5">
      <td>${new Date(p.date).toLocaleDateString()}</td>
      <td>-</td><td>-</td><td>-</td><td>-</td>
      <td>${p.amount}</td><td>-</td><td>-</td>
    </tr>`;
  });
}

/* ================= ADMIN ================= */
function toggleFarmers(){farmersBox.classList.toggle("hide")}
function togglePassword(){passwordBox.classList.toggle("hide")}

async function deleteFarmer(){
  await fetch(API+"/api/admin/farmer/"+farmerDeleteSelect.value,{
    method:"DELETE",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({adminPassword:adminDeletePass.value})
  });
  alert("Farmer deleted");
  loadFarmers();
}

async function changePassword(){
  await fetch(API+"/api/admin/change-password",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({oldPassword:oldPass.value,newPassword:newPass.value})
  });
  alert("Password updated");
}

function logout(){
  localStorage.clear();
  location.href="index.html";
}
</script>

</body>
</html>
